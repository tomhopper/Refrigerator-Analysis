---
title: "Refrigerator Analysis"
author: "Thomas Hopper"
date: '`r format(Sys.Date(), "%B %Y")`'
output: 
  html_document: 
    css: ~/Dropbox/R and RMD CSS and HTML headers-footers/rmd_doc_suffix.css
    highlight: tango
    theme: spacelab
bibliography: guy_refrigerator.bib

nocite: |
  @Alathea:2015qf, @Grolemund:2011ff, @R-Core-Team:2018lh, @Scrucca:2004oz, @Slowikowski:2018dk, @Wickham:2016ec, @Wickham:2017xr, @Xie:2014dp, @Zhu:2018kb
---


## The Problem

<span class="newthought">Guy has been measuring his refrigerator's electricity consumption</span> with a power meter. He wants to know if it's using too much electricity and should be replaced, or if it's running as expected.

The nameplate states that the unit will consume 296 kilowatt-hour (kWh) per year.

As we work through this problem, we need to think carefully about variation, the measurement process, and the relation of the data to the specification. In real-world problems, getting these right is often the difference between success and failure.

Is 296 kWh the design target or a projection based on some test? If it's a target, is it an upper specification ("not to exceed"), a mean, or the median? Does it mean that some percentage of the time, this model of refrigerator will consume at most 296 kWh of electricity under given test conditions (a statistical upper limit), or that the refrigerator is flat-out defective if it ever exceeds 296 kWh in a year (a go/no-go condition such as used in manufacturing)?

In this case, we don't know what it means, but we can say that if the expected range of electricity consumption is greater than this value, it's time for Guy to consider replacing his refrigerator.

## Setup

We'll use the following libraries in this analysis.

```{r libraries, warning=FALSE, message=FALSE}
library(tidyverse)
library(lubridate)
library(qcc)
library(ggrepel)
library(knitr)
library(kableExtra)
library(captioner)
```


```{r setup, include=FALSE}
opts_chunk$set(dev="png", 
               dev.args=list(type="cairo"),
               dpi=92,
               fig.width = 6,
               fig.height = 4)
```

```{r setup_captions, include=FALSE}
fig_nums <- captioner(prefix = "Figure")
fig_ts_raw_cap <- fig_nums(name = "fig_ts_raw",
                           caption = "Time series plot of the data.")
fig_ts_date_cap <- fig_nums(name = "fig_ts_date",
                            caption = "Plot of cumulative electricity consumption in kWh versus date.")
fig_ts_w_cap <- fig_nums(name = "fig_ts_w",
                         caption = "The average daily kWh used by date. Lines represent the span of days over which the average is taken.")
fig_i_cap <- fig_nums(name = "fig_i",
                      caption = "Individuals chart for the daily consumption data.")
fig_mr_cap <- fig_nums(name = "fig_mr",
                       caption = "Moving range chart for the daily consumption data.")
fig_dist_cap <- fig_nums(name = "fig_dist",
                       caption = "Comparison of predicted annual consumption and nameplate consumption.")

table_nums <- captioner(prefix = "Table")
table_rdata_cap <- table_nums(name = "tab_rdata",
                              caption = "The data provided by Guy.")
table_wdata_cap <- table_nums(name = "tab_wdata",
                              caption = "The data after wrangling.")
```

## The Data

```{r load_data, include=FALSE}
# The data ##
rf_df <- structure(list(Date = c("16/06/18", "29/06/18", "01/07/18", "06/07/18",
                                 "08/07/18", "13/07/18", "15/07/18", "21/07/18", 
                                 "22/07/18", "27/07/18",
                                 "03/08/18", "05/08/18", "10/08/18"), 
                        kWh = c(0, 6.32, 7.97, 12.07,
                                13.9, 0.4, 2.09, 6.42, 7.77, 
                                1.29, 6.73, 8.57, 12.42), 
                        Comment = c(NA, "PC", NA, NA, NA, "PC", NA, NA, NA, 
                                    "PC", NA, NA, NA)), 
                   .Names = c("Date", "kWh", "Comment"), 
                   class = c("tbl_df", "tbl", "data.frame"), 
                   row.names = c(NA, -13L), 
                   spec = structure(
                     list(cols = structure(
                       list(Date = structure(list(),
                                             class = c("collector_character",
                                                       "collector")), 
                            kWh = structure(list(), 
                                            class = c("collector_double",
                                                      "collector")), 
                            Comment = structure(list(),
                                                class = c("collector_character",
                                                          "collector"))), 
                       .Names = c("Date", "kWh", "Comment")), 
                       default = structure(list(), 
                                           class = c("collector_guess",
                                                     "collector"))), 
                     .Names = c("cols", "default"), 
                     class = "col_spec"))

```

This is a fairly small dataset, so we can print it in its entirity.

<span class="caption">`r table_nums('tab_rdata')`</span>
```{r raw_data, echo=FALSE}
kable(rf_df, format = "html") %>% kable_styling()
```

The power meter reports in cumulative kWh of electricity consumed. However, it resets every time there's a power outage, and there have been several of those. The time of the power outages is not known, but the first measurement after a power outage is identified with a "PC" in the $Comment$ variable.

As with the specification, we need to be careful in thinking about this data. Guy's measument process may be different than that intended by the manufacturer, and produce somewhat different results. That might not be a difference&mdash;a bias&mdash;of a factor of 2, but it could certainly be a bias of 20%.

Likewise, it's unlikely that the refrigerator will consume electricity at different rates over time. Warmer or cooler room temperatures will certainly alter electricity consumption, as will more or less frequent access of the refrigerator and longer or shorter durations of access. A big party

What this all means is that we need to use this small dataset for all that it's worth, making sure that we data from a single population and taking full advantage of any variation we find in the data.

## EDA

Here's how the data looks in raw form, plotted as a simple time series

```{r eda, fig.cap=fig_ts_raw_cap}
# Preliminary EDA ##
rf_df %>%
  mutate(index = row_number()) %>% 
  ggplot(aes(x = index, y = kWh)) +
  geom_point() +
  geom_label_repel(aes(label = Comment))
```

The cumulative nature of the reported energy consumption, and the occasional resets, are both obvious.

It's also appears that the consumption is not entirely linear&mdash;there is some variation in the rate of use from point to point. However, we're looking at the data by row number rather than by date; maybe the apparent variation is just due to the irregularity of observations. After wrangling the data, we'll look at this again.

Of note: the first data point precedes the first power outage. It seems unlikely that this will be of any use to us.

## Data wrangling

To predict annual electricity usage, we need to calculate a rate that we can then annualize. We can use the given cumulative numbers to derive an average daily rate between each observation. As we don't know when each reset point was, we have to be careful about how we use these values. For instance, we want to eliminate negative rates ("drops" in cumulative kWh due to a reset), and we can't make assumptions about when the power outages occur (i.e. we don't know where the '0's are).

```{r wrangle}
# Wrangle the data ##
# Fix the dates so we can do something useful
# Calculate the kWh used between each observation
# Calculate the days between observations
rf_df <- rf_df %>%
  mutate(Date = dmy(Date)) %>% 
  mutate(diff = kWh - lag(kWh),
         Date_Start = lag(Date)) %>% 
  mutate(days = Date - Date_Start) 

# Due to power outages, lines with "PC" have invalid $diff values, 
# so convert to NA
# Had some trouble doing this in dplyr due to the NAs...
rf_df$diff[rf_df$Comment == "PC" & !is.na(rf_df$Comment)] <- NA

# Now drop the Comment column, and then drop any rows 
# with NA values.
# This leaves us with useful observations of 
# kWh used between dates. 
# Now we calculate the average daily
# kWh consumption
rf_df <- rf_df %>% 
  select(-Comment) %>% 
  na.omit() %>% 
  mutate(daily_kWh = diff / as.integer(days))
```

`r table_nums("tab_wdata", display = "cite")` provides the full, wrangled dataset.

<span class="caption">`r table_nums('tab_wdata')`</span>
```{r show_data, results="asis", echo=FALSE}
kable(rf_df, format = "html") %>% kable_styling()
```

Now that we've fixed the $Date$ column, we can re-plot `r fig_nums("fig_ts_raw", display = "cite")` by date.

```{r raw_date, fig.cap=fig_ts_date_cap}
rf_df %>%
  ggplot(aes(x = Date, y = kWh)) +
  geom_point()
```

The apparent variation in daily energy consumption may be a little less, plotted this way, but it's still there. With a little more work, we might have made this a little more obvious by creating a grouping column and plotting a linear fit with `geom_smooth(method = 'lm')`, but for EDA that we're not sharing, eyeballing it is good enough. Either the refrigerator is not constant in its electricity consumption (as we expected), or the power meter is inconsistent in measurement. Possibly both are sources of variation here.

The key variable that we're interested in is the average daily electricity use, $daily\_kWh$, so let's plot it gainst the date of observation. Since this is an average over some number of days, it would be nice to also indicate over how many days each calculated value is averaged.


```{r analysis, fig.height=3, fig.width=5, fig.cap=fig_ts_w_cap}
# Analysis ##
# Basic time series plot of the data
rf_df %>% 
  ggplot() +
  geom_point(aes(x = Date, y = daily_kWh)) +
  geom_segment(aes(x = Date_Start, y = daily_kWh, xend = Date, yend = daily_kWh)) +
  labs(x = "Date",
       y = "Average Daily Consumption, kWh")
```

## Analysis and Results

Our analysis will check that the data is suitable for making predictions. We will then predict a range of possible annual values, and finally assess whether the specification of 296 kWh per annum falls with those predictions.

### Data homogeneity

In `r fig_nums("fig_ts_w", display = "cite")` there seems to be an unusually high (and maybe a low) value. Is this an outlier? Is it an artifact of the measurement process? Was Guy having a party and the refrigerator was seeing heavy use?

These questions are critical to our ability to reliably predict future data. We have sampled some process. In order to make predictions about the future, we need those samples to all come from a singular, or *homogeneous*, process. If we're seeing samples different, or *inhomogeneous*, processes then we either have to segregate the data or give up making predictions.

We can use an individuals and range chart ("ImR") to assess whether this data exhibits homogeneous properties&mdash;are we sampling from a single population of data and can make predictions about the future?

```{r qcc_i, fig.cap=fig_i_cap}
# Use qcc to plot the individual values and the moving range
rf_imr <- qcc(data = rf_df$daily_kWh, type = "xbar.one")
```
```{r qcc_mr, fig.cap=fig_mr_cap}
# Create the matrix used by qcc for the moving range chart.
# Column 1 is the individuals data; column 2 is the same data with
# a 1-row lag.
rf_daily_m <- matrix(c(rf_df$daily_kWh, lag(rf_df$daily_kWh)), 
                     byrow = FALSE, ncol = 2)
rf_r <- qcc(data = rf_daily_m, type = "R", sizes = 2)
```

With no out-of-control points on either the individuals or the moving range chart, it appears that we do have a homogeneous sample, and can continue with a prediction. However, nine sample points are not really enough to make this assessment with a high degree of confidence; we should continue collecting data until we have between 20 and 30 observations in our cleaned data set [@bpi:2016kh].

### Population parameter estimates

Given the *proviso* above, we now have estimates for key population parameters.

While the ImR chart treated each data point as being of equal weight, what we have with $daily\_kWh$ are means of observations over variable numbers of days. The grand mean should therefore be weighted by how many days' worth of data was collected. From `r fig_nums("fig_ts_w", display = "cite")`, we might expect that this will slightly reduce the mean of $daily\_kWh$ from that calculated in the individuals chart (the "center" line).

Since our estimate for the standard deviation is based on the sample-to-sample variance, it makes no sense to weight the calculation of standard deviation, and we'll just use the estimate provided by the moving range chart.

```{r pop_params}
# Calculate a mean and standard deviation
rf_daily_mean <- sum(rf_df$daily_kWh * as.integer(rf_df$days)) / sum(as.integer(rf_df$days))
rf_daily_sd <- rf_r$center
```

We have an average daily consumption of `r format(round(rf_daily_mean, 2), digits = 2)` kWh, with a standard deviation of `r format(round(rf_daily_sd, 2), digits = 2, nsmall = 2)` kWh.

### Simulating a year, over and over

With these population parameter estimates, we use Monte Carlo simulation to estimate annual electricity use for 1000 identical cases. We do this by simulating daily consumption for 365 days and adding to obtain an annual figure. We then repeat this process 1000 times.

```{r mc_sim}
# Use Monte Carlo simulation with these values to simulate
# 1000 identical refrigerators operating for a year
rf_annual <- replicate(expr = rnorm(n = 365, 
                                    mean = rf_daily_mean, 
                                    sd = rf_daily_sd) %>% 
                         sum(), 
                       n = 1000)

head(rf_annual)
```

We can compare the simulated annual performance to the nameplate performance with a histogram.

```{r fig_tol_v_spec, fig.cap=fig_dist_cap}
rf_annual_df <- data_frame(annual_kWh = rf_annual)
rf_annual_df %>% 
  ggplot(aes(x = annual_kWh)) +
  geom_histogram(bins = 10, aes(y = ..density..)) +
  geom_vline(xintercept = 296, color = "red") +
  labs(x = "Annual electricity use, kWh") +
  theme_linedraw() +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
```

```{r tols, echo=FALSE}
# How big do we want our prediction intervals?
sigmas <- 2

# Percent of cases covered by prediction interval
pi_percent_data <- paste0(format(x = (pnorm(sigmas) - pnorm(-sigmas)) * 100, 
                                 digits = 2, 
                                 nsmall = 0), 
                          "%")
```

This looks like the refrigerator is at least operating in the range of the nameplate electricity consumption.

### Tolerance intervals

Using the above Monte Carlo simulation, we can also create tolerance intervals to bracket the consumption values that we will likely see over a year's time. We will construct a `r sigmas`-sigma, or `r pi_percent_data`, tolerance interval with a 50% confidence level [@Wheeler:2016hs]. These can be used to assess whether the range of predicted performance is different than the nameplate performance.

```{r story}
# Data Story ##
# Population mean and standard deviation, based on the moving range
rf_annual_mean <- mean(rf_annual)
rf_annual_sd <- sd(rf_annual)
# Prediction interval lower and upper
lcl <- rf_annual_mean - sigmas * rf_annual_sd
ucl <- rf_annual_mean + sigmas * rf_annual_sd
```


```{r comparison_text, echo=FALSE}
rf_annual_mean_pt <- format(round(mean(rf_annual), 0), digits = 2)
rf_annual_sd_pt <- format(round(sd(rf_annual), 1), digits = 2)
rf_annual_lcl <- format(lcl, digits = 3)
rf_annual_ucl <- format(ucl, digits = 3)

if(lcl > 296) {
  compare_txt <- c("more than")
  action_txt <- c("consider replacing")
} else {
  action_txt <- c("not consider replacing")
  if(ucl < 296) {
    compare_txt <- c("less than")
  } else {
    compare_txt <- c("about the same as")
  }
}
```


## Conclusion

Based on the provided data, we can expect annual electricity use to fall between `r rf_annual_lcl` kWh and `r rf_annual_ucl` kWh. With a nameplate consumption of 296 kWh per annum, we can say that the refrigerator very likely consumes `r compare_txt` the nameplate. Guy should `r action_txt` his refrigerator.



# References